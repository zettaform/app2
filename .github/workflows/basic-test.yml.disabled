name: Basic EC2 Test

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/app2-key-pair.pem
        chmod 600 ~/.ssh/app2-key-pair.pem
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        
    - name: Basic EC2 Test
      run: |
        echo "ðŸ” Running basic EC2 test..."
        
        # Test 1: Basic SSH connection
        echo "Test 1: Basic SSH connection"
        ssh -i ~/.ssh/app2-key-pair.pem -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSH connection successful'"
        
        # Test 2: Check system info
        echo "Test 2: System information"
        ssh -i ~/.ssh/app2-key-pair.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "uname -a"
        
        # Test 3: Check disk space
        echo "Test 3: Disk space"
        ssh -i ~/.ssh/app2-key-pair.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "df -h"
        
        # Test 4: Check memory
        echo "Test 4: Memory"
        ssh -i ~/.ssh/app2-key-pair.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "free -h"
        
        # Test 5: Check if Node.js is installed
        echo "Test 5: Node.js check"
        ssh -i ~/.ssh/app2-key-pair.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "node --version || echo 'Node.js not installed'"
        
        # Test 6: Check if Docker is installed
        echo "Test 6: Docker check"
        ssh -i ~/.ssh/app2-key-pair.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "docker --version || echo 'Docker not installed'"
        
        # Test 7: Check network connectivity
        echo "Test 7: Network connectivity"
        ssh -i ~/.ssh/app2-key-pair.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "ping -c 3 8.8.8.8 || echo 'No internet connectivity'"
        
        # Test 8: Check user permissions
        echo "Test 8: User permissions"
        ssh -i ~/.ssh/app2-key-pair.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "whoami && groups && pwd && ls -la"
        
        # Test 9: Try to create a simple file
        echo "Test 9: File creation test"
        ssh -i ~/.ssh/app2-key-pair.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'Hello from EC2' > /home/ec2-user/test.txt && cat /home/ec2-user/test.txt && rm /home/ec2-user/test.txt"
        
        # Test 10: Check if we can install packages
        echo "Test 10: Package installation test"
        ssh -i ~/.ssh/app2-key-pair.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "sudo yum list installed | head -5 || echo 'Cannot list packages'"
        
        echo "âœ… All basic tests completed successfully!"
        
    - name: Cleanup
      if: always()
      run: |
        rm -f ~/.ssh/app2-key-pair.pem