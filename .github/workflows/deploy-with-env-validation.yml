name: Deploy with Environment Validation

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        
    - name: Validate GitHub Secrets
      run: |
        echo "ðŸ” VALIDATING GITHUB SECRETS"
        echo "============================="
        echo ""
        
        # Check required secrets
        if [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
          echo "âœ… AWS_ACCESS_KEY_ID: CONFIGURED"
        else
          echo "âŒ AWS_ACCESS_KEY_ID: NOT SET"
          exit 1
        fi
        
        if [ -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
          echo "âœ… AWS_SECRET_ACCESS_KEY: CONFIGURED"
        else
          echo "âŒ AWS_SECRET_ACCESS_KEY: NOT SET"
          exit 1
        fi
        
        if [ -n "${{ secrets.JWT_SECRET }}" ]; then
          echo "âœ… JWT_SECRET: CONFIGURED"
          JWT_LENGTH=${#JWT_SECRET}
          if [ $JWT_LENGTH -ge 32 ]; then
            echo "âœ… JWT_SECRET length: $JWT_LENGTH characters (valid)"
          else
            echo "âŒ JWT_SECRET length: $JWT_LENGTH characters (minimum 32 required)"
            exit 1
          fi
        else
          echo "âŒ JWT_SECRET: NOT SET"
          exit 1
        fi
        
        if [ -n "${{ secrets.ADMIN_GLOBAL_KEY }}" ]; then
          echo "âœ… ADMIN_GLOBAL_KEY: CONFIGURED"
        else
          echo "âŒ ADMIN_GLOBAL_KEY: NOT SET"
          exit 1
        fi
        
        if [ -n "${{ secrets.PASSWORD_SALT }}" ]; then
          echo "âœ… PASSWORD_SALT: CONFIGURED"
        else
          echo "âŒ PASSWORD_SALT: NOT SET"
          exit 1
        fi
        
        if [ -n "${{ secrets.EC2_SSH_PRIVATE_KEY }}" ]; then
          echo "âœ… EC2_SSH_PRIVATE_KEY: CONFIGURED"
        else
          echo "âŒ EC2_SSH_PRIVATE_KEY: NOT SET"
          exit 1
        fi
        
        if [ -n "${{ secrets.EC2_HOST }}" ]; then
          echo "âœ… EC2_HOST: CONFIGURED"
        else
          echo "âŒ EC2_HOST: NOT SET"
          exit 1
        fi
        
        if [ -n "${{ secrets.EC2_USER }}" ]; then
          echo "âœ… EC2_USER: CONFIGURED"
        else
          echo "âŒ EC2_USER: NOT SET"
          exit 1
        fi
        
        echo ""
        echo "ðŸŽ¯ All required secrets are configured!"
        
    - name: Test SSH Connection
      run: |
        echo "ðŸ”Œ TESTING SSH CONNECTION"
        echo "========================="
        echo ""
        
        # Test SSH connection
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'âœ… SSH connection successful'"
        
        echo ""
        echo "âœ… SSH connection test passed!"
        
    - name: Build Application
      run: |
        echo "ðŸ”¨ BUILDING APPLICATION"
        echo "======================="
        echo ""
        
        # Install dependencies
        npm install
        
        # Build the application
        npm run build
        
        echo ""
        echo "âœ… Application build completed!"
        
    - name: Create Deployment Package
      run: |
        echo "ðŸ“¦ CREATING DEPLOYMENT PACKAGE"
        echo "==============================="
        echo ""
        
        # Create deployment directory
        mkdir -p deployment
        
        # Copy application files
        cp -r dist deployment/
        cp -r src deployment/
        cp -r public deployment/
        cp package.json deployment/
        cp package-lock.json deployment/
        cp .env.production deployment/.env
        
        # Create deployment archive
        tar -czf app-deployment.tar.gz -C deployment .
        
        echo "âœ… Deployment package created: app-deployment.tar.gz"
        
    - name: Deploy to EC2
      run: |
        echo "ðŸš€ DEPLOYING TO EC2"
        echo "==================="
        echo ""
        
        # Copy deployment package to EC2
        scp -o StrictHostKeyChecking=no app-deployment.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/ec2-user/
        
        echo "âœ… Deployment package copied to EC2"
        
        # Deploy on EC2
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
          echo 'ðŸ”§ STARTING EC2 DEPLOYMENT'
          echo '=========================='
          echo ''
          
          # Stop any existing application
          echo 'ðŸ›‘ Stopping existing application...'
          pkill -f 'node.*server.js' || true
          pkill -f 'pm2' || true
          
          # Clean up previous deployment
          echo 'ðŸ§¹ Cleaning up previous deployment...'
          rm -rf /home/ec2-user/app-deployment
          rm -rf /home/ec2-user/app
          
          # Extract new deployment
          echo 'ðŸ“¦ Extracting new deployment...'
          mkdir -p /home/ec2-user/app-deployment
          tar -xzf /home/ec2-user/app-deployment.tar.gz -C /home/ec2-user/app-deployment
          
          # Create app directory
          echo 'ðŸ“ Creating app directory...'
          mkdir -p /home/ec2-user/app
          cp -r /home/ec2-user/app-deployment/* /home/ec2-user/app/
          cd /home/ec2-user/app
          
          # Install Node.js if not present
          echo 'ðŸ“¦ Checking Node.js installation...'
          if ! command -v node &> /dev/null; then
            echo 'Installing Node.js...'
            curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
            sudo yum install -y nodejs
          else
            echo 'Node.js already installed'
          fi
          
          # Install PM2 if not present
          echo 'ðŸ“¦ Checking PM2 installation...'
          if ! command -v pm2 &> /dev/null; then
            echo 'Installing PM2...'
            sudo npm install -g pm2
          else
            echo 'PM2 already installed'
          fi
          
          # Install dependencies
          echo 'ðŸ“¦ Installing dependencies...'
          npm install --production
          
          # Create .env file with actual values
          echo 'ðŸ”§ Creating .env file...'
          cat > .env << 'EOF'
# ========================================
# PRODUCTION ENVIRONMENT CONFIGURATION
# ========================================

# Application Configuration
NODE_ENV=production
PORT=3001
ENVIRONMENT=prod

# AWS Configuration
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}

# DynamoDB Tables
ADMIN_KEYS_TABLE=prod-admin-keys-table-admin-keys
EXTERNAL_USER_LOGS_TABLE=prod-external-user-creation-logs
DDB_USERS_TABLE=prod-users
DDB_CUSTOMERS_TABLE=prod-customers
DDB_FEEDBACK_TABLE=prod-feedback
DDB_ORDERS_TABLE=prod-orders
DDB_ANALYTICS_TABLE=prod-analytics
DDB_ADMIN_KEYS_TABLE=prod-admin-keys-table-admin-keys
DDB_EXTERNAL_LOGS_TABLE=prod-external-user-creation-logs

# Security & Authentication
ADMIN_GLOBAL_KEY=${{ secrets.ADMIN_GLOBAL_KEY }}
JWT_SECRET=${{ secrets.JWT_SECRET }}
PASSWORD_SALT=${{ secrets.PASSWORD_SALT }}

# CORS Configuration
CORS_ORIGIN=http://localhost:5174,https://yourdomain.com

# Logging Configuration
LOG_LEVEL=info
LOG_FILE_PATH=./logs/app.log

# Performance & Monitoring
MAX_REQUEST_SIZE=10mb
REQUEST_TIMEOUT=30000

# React App Environment Variables
REACT_APP_AWS_REGION=us-east-1
REACT_APP_ENVIRONMENT=prod
REACT_APP_API_BASE_URL=https://yourdomain.com/api
REACT_APP_BACKEND_URL=https://yourdomain.com
REACT_APP_BUILD_ENV=production
REACT_APP_AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
REACT_APP_AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
REACT_APP_ENABLE_LOGGING=false
REACT_APP_ENABLE_ANALYTICS=true

# Frontend Configuration
FRONTEND_API_BASE_URL=https://yourdomain.com/api
BACKEND_URL=https://yourdomain.com

# EC2 Deployment Configuration
EC2_HOST=${{ secrets.EC2_HOST }}
EC2_USER=${{ secrets.EC2_USER }}
EC2_SSH_KEY_PATH=app2-key-pair.pem
EOF
          
          # Set secure permissions on .env
          chmod 600 .env
          
          # Create logs directory
          mkdir -p logs
          
          # Start application with PM2
          echo 'ðŸš€ Starting application with PM2...'
          pm2 delete app2 || true
          pm2 start server.js --name app2 --env production
          
          # Save PM2 configuration
          pm2 save
          
          # Setup PM2 startup
          pm2 startup || true
          
          echo ''
          echo 'âœ… Application deployed successfully!'
          echo ''
          echo 'ðŸ“Š PM2 Status:'
          pm2 status
          echo ''
          echo 'ðŸ“‹ Application Logs:'
          pm2 logs app2 --lines 10
        "
        
        echo ""
        echo "âœ… Deployment to EC2 completed!"
        
    - name: Verify Deployment
      run: |
        echo "ðŸ” VERIFYING DEPLOYMENT"
        echo "======================="
        echo ""
        
        # Wait for application to start
        echo "â³ Waiting for application to start..."
        sleep 30
        
        # Check if application is running
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
          echo 'ðŸ” Checking application status...'
          pm2 status
          echo ''
          echo 'ðŸ“‹ Recent application logs:'
          pm2 logs app2 --lines 20
          echo ''
          echo 'ðŸŒ Testing local connectivity...'
          curl -f http://localhost:3001/health || echo 'Health check failed'
        "
        
        # Test external connectivity
        echo "ðŸŒ Testing external connectivity..."
        sleep 10
        
        if timeout 10 bash -c "</dev/tcp/${{ secrets.EC2_HOST }}/3001"; then
          echo "âœ… Application is accessible on port 3001"
        else
          echo "âŒ Application is not accessible on port 3001"
          echo "This might be due to security group configuration"
        fi
        
        echo ""
        echo "ðŸŽ¯ Deployment verification completed!"
        
    - name: Deployment Summary
      run: |
        echo "ðŸ“Š DEPLOYMENT SUMMARY"
        echo "====================="
        echo ""
        echo "âœ… GitHub secrets validated"
        echo "âœ… SSH connection established"
        echo "âœ… Application built and packaged"
        echo "âœ… Deployment package created"
        echo "âœ… Application deployed to EC2"
        echo "âœ… PM2 process manager configured"
        echo "âœ… Environment variables configured"
        echo ""
        echo "ðŸŒ Application URL: http://${{ secrets.EC2_HOST }}:3001"
        echo "ðŸ” Health Check: http://${{ secrets.EC2_HOST }}:3001/health"
        echo ""
        echo "ðŸš€ Deployment completed successfully!"